<div class="dashboard">

  <!-- NOTIFICACIÃ“N DE Ã‰XITO -->
  <div *ngIf="showSuccessNotification" class="success-notification">
    {{ successMessage }}
  </div>

  <!-- ALERTA PERSONALIZADA -->
  <div *ngIf="showCustomAlert" class="custom-alert-overlay" (click)="closeAlert()">
    <div class="custom-alert" [ngClass]="'alert-' + customAlertType" (click)="$event.stopPropagation()">
      <div class="alert-icon">{{ customAlertIcon }}</div>
      <div class="alert-content">
        <p class="alert-message">{{ customAlertMessage }}</p>
      </div>
      <button class="alert-close-btn" (click)="closeAlert()">Aceptar</button>
    </div>
  </div>

  <!-- CONFIRMACIÃ“N PERSONALIZADA -->
  <div *ngIf="showCustomConfirm" class="custom-confirm-overlay" (click)="closeConfirm()">
    <div class="custom-confirm" (click)="$event.stopPropagation()">
      <div class="confirm-header">
        <h3 class="confirm-title">{{ customConfirmTitle }}</h3>
        <button class="modal-close" (click)="closeConfirm()">âœ•</button>
      </div>
      <div class="confirm-content">
        <p class="confirm-message">{{ customConfirmMessage }}</p>
      </div>
      <div class="confirm-actions">
        <button class="btn-secondary" (click)="closeConfirm()">Cancelar</button>
        <button class="btn-primary" (click)="confirmAction()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="dashboard-header">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQxetRwKHF0eyrLM44loQHpENyIZhhN4-vRA&s" alt="KFC" class="brand-logo">
    <div class="header-center">
      <h1 class="dashboard-title">Estado de los servicios</h1>
      <p class="dashboard-subtitle">Monitoreo en tiempo real del estado de nuestros servicios</p>
    </div>
    <div class="header-right">
      <button class="notification-toggle" (click)="toggleNotifications()" [class.has-alerts]="activeNotifications.length > 0">
        <span class="notification-icon">ğŸ””</span>
        <span class="notification-badge" *ngIf="activeNotifications.length > 0">{{ activeNotifications.length }}</span>
      </button>
      <button class="notification-toggle settings-btn" (click)="toggleSettings()">
        <span class="settings-icon">âš™ï¸</span>
      </button>
    </div>
  </header>

  <!-- PANEL DE NOTIFICACIONES -->
  <div class="notifications-panel" [class.open]="showNotifications">
    <div class="notifications-header">
      <h3>ğŸ”” Notificaciones Activas</h3>
      <button class="close-btn" (click)="toggleNotifications()">âœ•</button>
    </div>

    <!-- Toggle de notificaciones -->
    <div class="notifications-toggle">
      <div class="toggle-info">
        <span class="toggle-label">Notificaciones automÃ¡ticas</span>
        <span class="toggle-description">Alertas cuando cambia el estado de servicios</span>
      </div>
      <label class="switch">
        <input type="checkbox" [(ngModel)]="notificationsEnabled" (change)="toggleNotificationsEnabled()">
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="notifications-content">
      <div *ngIf="activeNotifications.length === 0" class="no-notifications">
        <p>âœ… No hay alertas activas</p>
        <span>Todos los servicios estÃ¡n funcionando correctamente</span>
      </div>

      <div class="notification-item" *ngFor="let notif of activeNotifications" 
           [ngClass]="{
             'critical': notif.severity === 'critical',
             'warning': notif.severity === 'warning',
             'info': notif.severity === 'info'
           }">
        <div class="notif-icon">{{ notif.icon }}</div>
        <div class="notif-content">
          <div class="notif-title">{{ notif.title }}</div>
          <div class="notif-message">{{ notif.message }}</div>
          <div class="notif-time">{{ notif.timestamp | date:'short' }}</div>
          <div class="notif-actions" *ngIf="notif.actions && notif.actions.length > 0">
            <button 
              *ngFor="let action of notif.actions" 
              class="notif-action-btn" 
              (click)="action.callback(); dismissNotification(notif.id)">
              {{ action.label }}
            </button>
          </div>
        </div>
        <button class="dismiss-btn" (click)="dismissNotification(notif.id)" title="Descartar">âœ•</button>
      </div>
    </div>

    <div class="notifications-footer">
      <button class="btn-secondary" (click)="clearAllNotifications()" *ngIf="activeNotifications.length > 0">
        ğŸ—‘ï¸ Limpiar todas
      </button>
    </div>
  </div>

  <!-- Overlay para cerrar panel -->
  <div class="notifications-overlay" *ngIf="showNotifications" (click)="toggleNotifications()"></div>

  <section *ngIf="showSettings" class="settings-modal-overlay" (click)="toggleSettings()">
    <div class="settings-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>âš™ï¸ Ajustes del Sistema</h2>
        <button class="modal-close" (click)="toggleSettings()">âœ•</button>
      </div>
      <div class="modal-content">
        <app-settings 
          (onSaved)="loadData()" 
          (onCreateService)="toggleSettings(); toggleCreateService()"
          (onEditService)="openEditFromSettings()"
          (onDeleteService)="openDeleteFromSettings()">
        </app-settings>
      </div>
    </div>
  </section>

  <!-- MODAL SELECCIONAR Y EDITAR SERVICIO -->
  <section *ngIf="showEditServiceModal" class="settings-modal-overlay" (click)="toggleEditServiceModal()">
    <div class="settings-modal edit-service-modal" [class.edit-service-modal-expanded]="editingService" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>âœï¸ Editar Servicio</h2>
        <button class="modal-close" (click)="toggleEditServiceModal()">âœ•</button>
      </div>
      <div class="modal-content">
        <!-- Selector de servicio -->
        <div class="edit-service-selector">
          <label class="selector-label">Selecciona el servicio a editar:</label>
          <select [(ngModel)]="selectedServiceToEdit" (change)="onServiceSelectChange()" class="service-select">
            <option value="">-- Seleccionar servicio --</option>
            <option *ngFor="let s of services" [value]="s._id" [hidden]="s.activo === false">
              {{ s.nombre }} - {{ s.estado }}
            </option>
          </select>
        </div>

        <!-- Formulario de ediciÃ³n (aparece cuando se selecciona un servicio) -->
        <div *ngIf="editingService" class="edit-service-form">
          <div class="form-row">
            <label>Nombre</label>
            <input [(ngModel)]="editingService.nombre" placeholder="Nombre del servicio" />
          </div>

          <div class="form-row">
            <label>DescripciÃ³n</label>
            <textarea [(ngModel)]="editingService.descripcion" placeholder="DescripciÃ³n del servicio"></textarea>
          </div>

          <div class="form-row">
            <label>Cadena</label>
            <input [(ngModel)]="editingService.clasificacion.cadena" placeholder="Ej: KFC, AMERICAN" />
          </div>

          <div class="form-row">
            <label>Restaurante</label>
            <input [(ngModel)]="editingService.clasificacion.restaurante" placeholder="Ej: G008, K001" />
          </div>

          <div class="form-row">
            <label>URL</label>
            <input [(ngModel)]="editingService.endpoint.url" placeholder="https://example.com/health" />
          </div>

          <div class="form-row">
            <label>MÃ©todo HTTP</label>
            <select [(ngModel)]="editingService.endpoint.metodo">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="PATCH">PATCH</option>
              <option value="DELETE">DELETE</option>
              <option value="HEAD">HEAD</option>
            </select>
          </div>

          <div class="form-row">
            <label>Importancia</label>
            <select [(ngModel)]="editingService.importancia">
              <option value="alta">Alta</option>
              <option value="media">Media</option>
              <option value="baja">Baja</option>
            </select>
          </div>

          <div class="form-row checkbox-row">
            <input type="checkbox" id="modalManualImportancia" [(ngModel)]="editingService.manualImportanciaOverride" />
            <label for="modalManualImportancia" style="font-size: 13px;" title="Evita que el sistema aumente automÃ¡ticamente la importancia cuando el servicio tenga problemas">
              ğŸ”’ Bloquear escalamiento automÃ¡tico de importancia
            </label>
          </div>
          <div *ngIf="editingService.manualImportanciaOverride" class="info-box">
            â„¹ï¸ El sistema no modificarÃ¡ automÃ¡ticamente la importancia de este servicio, incluso si estÃ¡ interrumpido o impactado.
          </div>

          <div class="form-row checkbox-row">
            <input type="checkbox" id="modalActivo" [(ngModel)]="editingService.activo" />
            <label for="modalActivo">Activo</label>
          </div>
        </div>

        <!-- Acciones -->
        <div class="edit-modal-actions">
          <button class="btn-secondary" (click)="toggleEditServiceModal()">Cancelar</button>
          <button class="btn-primary" *ngIf="editingService" (click)="saveEditFromModal()" [disabled]="savingEdit">
            {{ savingEdit ? 'ğŸ’¾ Guardando...' : 'âœ“ Guardar cambios' }}
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- MODAL ELIMINAR SERVICIO -->
  <section *ngIf="showDeleteServiceModal" class="settings-modal-overlay" (click)="toggleDeleteServiceModal()">
    <div class="settings-modal delete-service-modal" (click)="$event.stopPropagation()">
      <div class="modal-header modal-header-danger">
        <h2>ğŸ—‘ï¸ Eliminar Servicio</h2>
        <button class="modal-close" (click)="toggleDeleteServiceModal()">âœ•</button>
      </div>
      <div class="modal-content">
        <div class="delete-service-selector">
          <label class="selector-label">Selecciona el servicio a eliminar:</label>
          <select [(ngModel)]="selectedServiceToDelete" class="service-select">
            <option value="">-- Seleccionar servicio --</option>
            <option *ngFor="let s of services" [value]="s._id" [hidden]="s.activo === false">
              {{ s.nombre }} - {{ s.estado }}
            </option>
          </select>

          <div *ngIf="selectedServiceToDelete" class="delete-warning">
            <span class="warning-icon">âš ï¸</span>
            <p>El servicio serÃ¡ marcado como eliminado. PodrÃ¡s recuperarlo desde "Ver servicios eliminados" en Ajustes.</p>
          </div>
        </div>

        <div class="edit-modal-actions">
          <button class="btn-secondary" (click)="toggleDeleteServiceModal()">Cancelar</button>
          <button class="btn-danger" (click)="deleteServiceFromModal()" [disabled]="!selectedServiceToDelete || deleting">
            {{ deleting ? 'ğŸ—‘ï¸ Eliminando...' : 'ğŸ—‘ï¸ Eliminar servicio' }}
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section class="stats-grid">
    <div class="stat-card stat-health">
      <div class="stat-header">
        <span class="stat-label">Salud General</span>
        <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="#5084C1"><path d="M362-180q-17 0-30.67-9.67-13.66-9.66-19.33-24.66l-95.33-232.34H45.33v-66.66h218l98.67 242 186-473q5.67-15 19.33-24.67 13.67-9.67 30.67-9.67t30.67 9.67q13.66 9.67 19.33 24.67l95.33 231h171.34v66.66h-218L598-687.33l-186 473q-5.67 15-19.33 24.66Q379-180 362-180Z"/></svg></span>
      </div>
      <span class="stat-value">{{ resumen.saludGeneral || 'â€”' }}%</span>
      <div class="stat-details">
        <div class="detail-row">
          <span class="detail-label">Estabilidad:</span>
          <span class="detail-value">{{ resumen.estabilidad || 'â€”' }}%</span>
        </div>
        <div class="stability-bar">
          <div class="stability-fill" [style.width.%]="resumen.estabilidad || 0"></div>
        </div>
      </div>
      <span class="stat-meta">{{ resumen.totalServicios || 0 }} servicios totales</span>
    </div>

    <div class="stat-card stat-ok">
      <div class="stat-header">
        <span class="stat-label">Operando</span>
        <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="#78A75A"><path d="M379.33-244 154-469.33 201.67-517l177.66 177.67 378.34-378.34L805.33-670l-426 426Z"/></svg></span>
      </div>
      <span class="stat-value">{{ resumen.operando || 0 }}</span>
      <span class="stat-meta">{{ (resumen.operando || 0) > 0 ? (resumen.operando / resumen.totalServicios * 100).toFixed(1) : '0' }}%</span>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-header">
        <span class="stat-label">Con problemas</span>
        <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="#9A9A0BD4"><path d="M446.67-386.67V-760h66.66v373.33h-66.66Zm0 186.67v-66.67h66.66V-200h-66.66Zm-218 160h-122q-27 0-46.84-19.83Q40-79.67 40-106.67v-122h66.67v122h122V-40Zm502.66 0v-66.67h122v-122H920v122q0 27-19.83 46.84Q880.33-40 853.33-40h-122ZM40-731.33v-122q0-27 19.83-46.84Q79.67-920 106.67-920h122v66.67h-122v122H40Zm813.33 0v-122h-122V-920h122q27 0 46.84 19.83Q920-880.33 920-853.33v122h-66.67Z"/></svg></span>
      </div>
      <span class="stat-value">{{ (resumen.impactado || 0) + (resumen.degradado || 0) }}</span>
      <span class="stat-meta">{{ ((resumen.impactado || 0) + (resumen.degradado || 0)) > 0 ? (((resumen.impactado || 0) + (resumen.degradado || 0)) / resumen.totalServicios * 100).toFixed(1) : '0' }}%</span>
    </div>

    <div class="stat-card stat-down">
      <div class="stat-header">
        <span class="stat-label">Interrumpidos</span>
        <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="#EA3323"><path d="M304.67-269.33H365l113.67-181.34L592-269.33h63.33l-143-220 132.34-201.34h-60.34l-104 165.34-104-165.34h-63L447-488.33l-142.33 219ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-.32-66.67q138.67 0 236.16-97.16 97.49-97.17 97.49-235.85 0-138.67-97.49-236.16-97.49-97.49-236.16-97.49-138.68 0-235.85 97.49-97.16 97.49-97.16 236.16 0 138.68 97.16 235.85 97.17 97.16 235.85 97.16ZM480-480Z"/></svg></span>
      </div>
      <span class="stat-value">{{ resumen.interrumpido || 0 }}</span>
      <span class="stat-meta">{{ (resumen.interrumpido || 0) > 0 ? (resumen.interrumpido / resumen.totalServicios * 100).toFixed(1) : '0' }}%</span>
    </div>
  </section>

  <!-- TABS (Sin botÃ³n MÃ©tricas) -->
  <nav class="tabs-nav">
    <button class="tab-button" [class.active]="activeTab === 'actual'" (click)="setActiveTab('actual')">Estado Actual</button>
    <button class="tab-button" [class.active]="activeTab === 'historial'" (click)="setActiveTab('historial')">Historial</button>
    <button class="tab-button" [class.active]="activeTab === 'tendencias'" (click)="setActiveTab('tendencias')">Tendencias</button>
    <button class="tab-button" [class.active]="activeTab === 'mantenimiento'" (click)="setActiveTab('mantenimiento')">Mantenimiento</button>
    <button class="tab-button" [class.active]="activeTab === 'calendario'" (click)="setActiveTab('calendario')">Calendario</button>
    <button class="tab-button" [class.active]="activeTab === 'incidentes'" (click)="setActiveTab('incidentes')">Incidentes</button>
  </nav>

  <!-- HISTORIAL DE ESTADOS -->
  <section *ngIf="activeTab === 'historial'" class="history-section">
    <div class="history-card">
      <div class="history-header">
        <h2 class="section-title">ğŸ“‹ Historial de Health Checks</h2>
        <p class="history-subtitle">Ãšltimas verificaciones de estado de los servicios, ordenados por prioridad</p>
      </div>

      <!-- Filtros del Historial -->
      <div class="filters-bar checks-filters">
        <div class="filters-row">
          <div class="filter-item">
            <label>Desde</label>
            <input type="date" [(ngModel)]="filtroHistorialDesde" />
          </div>
          <div class="filter-item">
            <label>Hasta</label>
            <input type="date" [(ngModel)]="filtroHistorialHasta" />
          </div>
          <div class="filter-item">
            <label>Estado</label>
            <select [(ngModel)]="filtroHistorialEstado">
              <option value="">Todos</option>
              <option *ngFor="let e of estados" [value]="e">{{ e }}</option>
            </select>
          </div>
          <div class="filter-item">
            <label>Importancia</label>
            <select [(ngModel)]="filtroHistorialImportancia">
              <option value="">Todas</option>
              <option value="alta">Alta</option>
              <option value="media">Media</option>
              <option value="baja">Baja</option>
            </select>
          </div>
          <div class="filter-item">
            <label>Cadena</label>
            <input list="cadenasList" [(ngModel)]="filtroHistorialCadena" placeholder="Filtrar..." />
          </div>
          <div class="filter-item">
            <label>Restaurante</label>
            <input list="restaurantesList" [(ngModel)]="filtroHistorialRestaurante" placeholder="Filtrar..." />
          </div>
        </div>
        <div class="filter-actions">
          <button class="btn-secondary" (click)="limpiarFiltrosHistorial()">Limpiar</button>
          <button class="btn-primary" (click)="aplicarFiltrosHistorial()">Filtrar</button>
        </div>
      </div>
      
      <div class="history-legend">
        <span class="legend-item"><span class="legend-color legend-interrupcion"></span> InterrupciÃ³n</span>
        <span class="legend-item"><span class="legend-color legend-problemas"></span> Impactado/Degradado</span>
        <span class="legend-item"><span class="legend-color legend-operando"></span> Operando</span>
      </div>

      <!-- Selector de Vista -->
      <div class="history-view-selector">
        <button 
          class="view-btn" 
          [class.active]="historialViewMode === 'checks'"
          (click)="switchHistorialView('checks')">
          Ver Health Checks
        </button>
        <button 
          class="view-btn" 
          [class.active]="historialViewMode === 'calendar'"
          (click)="switchHistorialView('calendar')">
          Ver por DÃ­as
        </button>
      </div>

      <!-- VISTA DE HEALTH CHECKS (CARRUSEL) -->
      <div *ngIf="historialViewMode === 'checks'">
        <!-- SERVICIOS CON SUS HEALTH CHECKS EN CARRUSEL -->
      <div *ngFor="let serviceGroup of historyByService; let i = index" class="history-status-section">
        <div class="carousel-header">
          <h3 class="carousel-title history-status-title">
            <span class="status-icon">{{ serviceGroup.statusIcon }}</span>
            {{ serviceGroup.serviceName }}
            <span class="service-count">({{ serviceGroup.checks.length }} checks)</span>
            <span class="health-badge-inline" [ngClass]="{
              'badge-down': serviceGroup.latestStatus === 'Interrumpido',
              'badge-impact': serviceGroup.latestStatus === 'Impactado',
              'badge-degraded': serviceGroup.latestStatus === 'Degradado',
              'badge-ok': serviceGroup.latestStatus === 'Operando normalmente'
            }">{{ serviceGroup.latestStatus }}</span>
          </h3>
        </div>
        <div class="carousel-wrapper">
          <div class="carousel-container carousel-container-{{ i }}">
            <div class="health-card history-health-card" 
                 *ngFor="let check of serviceGroup.checks; trackBy: trackByHealthCheckId"
                 [ngClass]="{
                   'ok': check.estado === 'Operando normalmente',
                   'impact': check.estado === 'Impactado',
                   'degraded': check.estado === 'Degradado',
                   'down': check.estado === 'Interrumpido'
                 }">
              <div class="health-header">
                <div class="health-title">
                  <span class="health-badge">{{ check.estado }}</span>
                  <span *ngIf="check.importancia" class="health-importance">âš‘ {{ check.importancia }}</span>
                </div>
              </div>
              <div class="health-meta" *ngIf="check.cadena || check.restaurante">
                <span *ngIf="check.cadena">{{ check.cadena }}</span>
                <span *ngIf="check.restaurante">{{ check.restaurante }}</span>
              </div>
              <div class="health-details">
                <span *ngIf="check.tiempoRespuestaMs" class="detail-item">â± {{ check.tiempoRespuestaMs }} ms</span>
                <span *ngIf="check.codigoRespuesta" class="detail-item">ğŸ”¢ {{ check.codigoRespuesta }}</span>
                <span class="detail-item">ğŸ•’ {{ check.fechaRevision || check.fecha | date:'short' }}</span>
              </div>
              <div class="health-message" *ngIf="check.mensaje">{{ check.mensaje }}</div>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- VISTA DE CALENDARIO POR DÃAS -->
      <div *ngIf="historialViewMode === 'calendar'" class="calendar-view">
        <div class="calendar-legend">
          <span class="legend-item"><span class="legend-dot legend-ok"></span> Operacional</span>
          <span class="legend-item"><span class="legend-dot legend-degraded"></span> Problemas</span>
          <span class="legend-item"><span class="legend-dot legend-down"></span> InterrupciÃ³n</span>
        </div>

        <div class="service-timeline" *ngFor="let service of servicesForCalendar">
          <h3 class="timeline-service-name">{{ service.nombre }}</h3>
          <div class="timeline-days">
            <div 
              *ngFor="let day of service.days" 
              class="day-cell"
              [ngClass]="{
                'day-ok': day.status === 'Operando normalmente',
                'day-degraded': day.status === 'Impactado' || day.status === 'Degradado',
                'day-down': day.status === 'Interrumpido',
                'day-empty': !day.status
              }"
              [title]="(day.date | date:'dd/MM/yyyy') + ': ' + (day.status || 'Sin datos')">
            </div>
          </div>
          <div class="timeline-dates">
            <span>{{ getCalendarEndDate() | date:'dd/MM' }}</span>
            <span>{{ getCalendarStartDate() | date:'dd/MM' }}</span>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- TENDENCIAS -->
  <section *ngIf="activeTab === 'tendencias'" class="trends-section">
    <div class="trends-header">
      <h2 class="section-title">ğŸ“Š Tendencias de Servicios (Ãšltimos 30 dÃ­as)</h2>
      <p class="trends-subtitle">AnÃ¡lisis histÃ³rico del estado y disponibilidad de servicios</p>
    </div>
    
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">DistribuciÃ³n de Estados por DÃ­a</h3>
        <p class="chart-subtitle">Cantidad de servicios en cada estado</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="statusAreaChart"></canvas>
      </div>
    </div>
    
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Porcentaje de Disponibilidad General</h3>
        <p class="chart-subtitle">Disponibilidad promedio del sistema</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="availabilityChart"></canvas>
      </div>
    </div>
  </section>

  <!-- INCIDENTES TAB -->
  <section *ngIf="activeTab === 'incidentes'" class="incidents-section">
    <div class="incidents-header">
      <h2 class="section-title">ğŸ“‹ Crear Incidente</h2>
      <p class="incidents-subtitle">Registra un nuevo incidente en el sistema</p>
    </div>

    <div class="incidents-create">
      <div class="form-row">
        <label>Servicio</label>
        <select [(ngModel)]="newIncident.serviceId" (change)="onIncidentServiceChange()">
          <option value="">-- Seleccionar servicio --</option>
          <option *ngFor="let s of services" [value]="s._id" [hidden]="s.activo === false">{{ s.nombre }}</option>
        </select>
      </div>
      <div class="form-row">
        <label>TÃ­tulo</label>
        <input [(ngModel)]="newIncident.titulo" placeholder="TÃ­tulo del incidente" />
      </div>
      <div class="form-row">
        <label>DescripciÃ³n</label>
        <textarea [(ngModel)]="newIncident.descripcion" placeholder="DescripciÃ³n detallada"></textarea>
      </div>
      <div class="form-row">
        <label>Estado</label>
        <select [(ngModel)]="newIncident.estado">
          <option value="Abierto">Abierto</option>
          <option value="En progreso">En progreso</option>
          <option value="Resuelto">Resuelto</option>
        </select>
      </div>

      <div class="form-row">
        <label>Severidad</label>
        <select [(ngModel)]="newIncident.severidad">
          <option value="Baja">Baja</option>
          <option value="Media">Media</option>
          <option value="Alta">Alta</option>
        </select>
      </div>

      <div class="form-row">
        <label>Cadena</label>
        <input [(ngModel)]="newIncident.cadena" placeholder="Cadena de restaurante" />
      </div>

      <div class="form-row">
        <label>Restaurante</label>
        <input [(ngModel)]="newIncident.restaurante" placeholder="Restaurante especÃ­fico" />
      </div>
      <div class="form-actions">
        <button class="btn-primary" (click)="createIncident()">Crear incidente</button>
        <button class="btn-secondary" (click)="toggleDeleteIncident()">Borrar incidente</button>
        <button class="btn-danger" (click)="confirmDeleteAllIncidents()">EliminaciÃ³n Total</button>
      </div>
    </div>

    <!-- Modal para eliminar incidente -->
    <section *ngIf="showDeleteIncident" class="delete-incident-modal-overlay" (click)="toggleDeleteIncident()">
      <div class="delete-incident-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>ğŸ—‘ï¸ Eliminar Incidente</h2>
          <button class="modal-close" (click)="toggleDeleteIncident()">âœ•</button>
        </div>
        <div class="modal-content">
          <p class="modal-subtitle">Selecciona el incidente que deseas eliminar</p>
          
          <div class="form-row">
            <label>Seleccionar Incidente</label>
            <select [(ngModel)]="selectedIncidentToDelete">
              <option value="">-- Seleccionar incidente --</option>
              <option *ngFor="let incident of incidents" [value]="incident._id">
                {{ incident.titulo }} ({{ incident.severidad }}) - {{ incident.estado }}
              </option>
            </select>
          </div>

          <div class="form-actions">
            <button class="btn-primary btn-delete" (click)="confirmAndDeleteIncident()" [disabled]="deletingIncident || !selectedIncidentToDelete">
              {{ deletingIncident ? 'â³ Eliminando...' : 'ğŸ—‘ï¸ Eliminar' }}
            </button>
            <button class="btn-secondary" (click)="toggleDeleteIncident()" [disabled]="deletingIncident">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Lista de incidentes recientes -->
    <div class="incidents-list">
      <div class="incidents-list-header">
        <h3 class="section-title" style="margin-top: 32px;">Incidentes Recientes</h3>
      </div>
      <div
        class="incident-card"
        *ngFor="let incident of incidents"
        [ngClass]="{
          'high': incident.severidad === 'Alta',
          'medium': incident.severidad === 'Media',
          'low': incident.severidad === 'Baja'
        }">
        <div class="incident-header">
          <h4>{{ incident.titulo }}</h4>
          <span class="incident-status" [ngClass]="incident.estado.toLowerCase().replace(' ', '-')">
            {{ incident.estado }}
          </span>
        </div>
        <p class="incident-description">{{ incident.descripcion }}</p>
        <div class="incident-meta">
          <span class="meta-item">ğŸª {{ incident.cadena || 'Sin cadena' }}</span>
          <span class="meta-item">ğŸ“ {{ incident.restaurante || 'Sin restaurante' }}</span>
          <span class="meta-item severity" [ngClass]="'severity-' + incident.severidad.toLowerCase()">
            {{ incident.severidad }}
          </span>
        </div>
      </div>
      <div *ngIf="!incidents || incidents.length === 0" class="no-incidents">
        No hay incidentes registrados ğŸ‰
      </div>
    </div>
  </section>

  <!-- MANTENIMIENTO -->
  <section class="maintenance-section" *ngIf="activeTab === 'mantenimiento'">
    <h2 class="section-title">Mantenimiento</h2>
    <div class="maintenance-area">
      <app-maintenance (onSaved)="onMaintenanceSaved()"></app-maintenance>
    </div>
  </section>

  <!-- CALENDARIO -->
  <section class="calendar-section compact" *ngIf="activeTab === 'calendario'">
    <div class="calendar-main-layout">
      <!-- Calendario principal (izquierda) -->
      <div class="calendar-left">
        <div class="calendar-header">
          <h2 class="calendar-month">
            ğŸ“… {{ getMonthName(currentMonth) }} {{ currentYear }}
          </h2>
          <div class="calendar-nav">
            <button class="nav-button" (click)="previousMonth()">â€¹</button>
            <button class="nav-button" (click)="nextMonth()">â€º</button>
          </div>
        </div>

        <div class="calendar-weekdays">
          <div class="weekday">D</div>
          <div class="weekday">L</div>
          <div class="weekday">M</div>
          <div class="weekday">M</div>
          <div class="weekday">J</div>
          <div class="weekday">V</div>
          <div class="weekday">S</div>
        </div>

        <div class="calendar-grid compact">
          <div
            *ngFor="let day of calendarDays"
            class="calendar-day"
            [class.today]="day.isToday"
            [class.empty]="!day.date"
          >
            <span class="day-number" *ngIf="day.date">{{ day.date }}</span>
            <span
              *ngIf="day.incident"
              class="incident-indicator"
              [ngClass]="{
                'warning': day.incident.status === 'warning',
                'down': day.incident.status === 'down'
              }"
            ></span>
          </div>
        </div>
      </div>

      <!-- Panel derecho con incidentes y estadÃ­sticas -->
      <div class="calendar-right">
        <!-- Incidentes del mes -->
        <div class="calendar-incidents compact">
          <h3 class="calendar-incidents-title">âš ï¸ Incidentes del Mes</h3>
          <div class="incidents-list" *ngIf="recentIncidents.length > 0">
            <div class="incident-item compact" *ngFor="let incident of recentIncidents">
              <div class="incident-header">
                <span class="incident-service" [title]="incident.service">{{ incident.service }}</span>
                <span class="incident-date">{{ incident.date }}</span>
              </div>
              <div class="incident-description">{{ incident.description }}</div>
            </div>
          </div>
          <div class="incident-empty" *ngIf="!recentIncidents.length">
            âœ… Sin incidentes este mes
          </div>
        </div>

        <!-- EstadÃ­sticas compactas -->
        <div class="calendar-stats-compact">
          <div class="stat-mini">
            <span class="stat-mini-icon">ğŸ”§</span>
            <div class="stat-mini-info">
              <span class="stat-mini-value">{{ monthlyMaintenances.length }}</span>
              <span class="stat-mini-label">Mant. Prog.</span>
            </div>
          </div>
          <div class="stat-mini">
            <span class="stat-mini-icon">âš¡</span>
            <div class="stat-mini-info">
              <span class="stat-mini-value active">{{ activeMaintenances }}</span>
              <span class="stat-mini-label">Activos</span>
            </div>
          </div>
          <div class="stat-mini">
            <span class="stat-mini-icon">âš ï¸</span>
            <div class="stat-mini-info">
              <span class="stat-mini-value problem">{{ servicesWithProblems }}</span>
              <span class="stat-mini-label">Problemas</span>
            </div>
          </div>
          <div class="stat-mini">
            <span class="stat-mini-icon">â±ï¸</span>
            <div class="stat-mini-info">
              <span class="stat-mini-value">{{ avgResolutionTime }}</span>
              <span class="stat-mini-label">ResoluciÃ³n</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas rÃ¡pidas en la parte inferior -->
    <div class="calendar-alerts-row">
      <div class="alert-box compact">
        <h4 class="alert-box-title">ğŸš¨ Incidentes Sin Resolver</h4>
        <div class="alert-list horizontal">
          <div class="alert-item compact" *ngFor="let incident of unresolvedIncidents">
            <span class="alert-service">{{ incident.service }}</span>
            <span class="alert-severity compact" [ngClass]="incident.severity.toLowerCase()">{{ incident.severity }}</span>
          </div>
          <span class="alert-empty" *ngIf="unresolvedIncidents.length === 0">âœ… Ninguno</span>
        </div>
      </div>

      <div class="alert-box compact">
        <h4 class="alert-box-title">â° Mant. Vencidos</h4>
        <div class="alert-list horizontal">
          <div class="alert-item compact" *ngFor="let maint of overdueMaintenances">
            <span class="alert-service">{{ maint.service }}</span>
            <span class="alert-overdue compact">{{ maint.daysOverdue }}d</span>
          </div>
          <span class="alert-empty" *ngIf="overdueMaintenances.length === 0">âœ… Ninguno</span>
        </div>
      </div>

      <div class="alert-box compact affected">
        <h4 class="alert-box-title">âš¡ MÃ¡s Afectados</h4>
        <div class="alert-list horizontal">
          <div class="alert-item compact" *ngFor="let svc of mostAffectedServices">
            <span class="alert-service">{{ svc.name }}</span>
            <span class="svc-count compact">{{ svc.count }}</span>
          </div>
          <span class="alert-empty" *ngIf="mostAffectedServices.length === 0">Ninguno</span>
        </div>
      </div>
    </div>
  </section>

  <!-- LISTA DE SERVICIOS -->
  <section class="services-section" *ngIf="activeTab !== 'mantenimiento' && activeTab !== 'calendario' && activeTab !== 'tendencias' && activeTab !== 'historial' && activeTab !== 'incidentes'">
    <h2 class="section-title">Lista de Servicios</h2>

    <div style="margin-bottom:12px">
      <!-- mantenimiento movido al final de la pÃ¡gina para mejor orden visual -->
    </div>

    <div class="filters-bar">
      <div class="filters-row">
        <div class="filter-item">
          <label>Estado</label>
          <select [(ngModel)]="filtroServiciosEstado">
            <option value="">Todos</option>
            <option *ngFor="let e of estados" [value]="e">{{ e }}</option>
          </select>
        </div>
        <div class="filter-item">
          <label>Importancia</label>
          <select [(ngModel)]="filtroServiciosImportancia">
            <option value="">Todas</option>
            <option value="alta">Alta</option>
            <option value="media">Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
        <div class="filter-item">
          <label>Cadena</label>
          <input list="cadenasList" [(ngModel)]="filtroServiciosCadena" placeholder="Filtrar..." />
        </div>
        <div class="filter-item">
          <label>Restaurante</label>
          <input list="restaurantesList" [(ngModel)]="filtroServiciosRestaurante" placeholder="Filtrar..." />
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn-secondary" (click)="filtroServiciosEstado=''; filtroServiciosImportancia=''; filtroServiciosCadena=''; filtroServiciosRestaurante=''">Limpiar</button>
        <button class="btn-primary" (click)="currentPage = 1">Filtrar</button>
      </div>
    </div>

    <div class="services-grid">
      <div
        class="service-card"
        *ngFor="let service of filteredServices"
        [ngClass]="{
          'ok': service.estado === 'Operando normalmente',
          'impact': service.estado === 'Impactado',
          'degraded': service.estado === 'Degradado',
          'down': service.estado === 'Interrumpido'
        }"
      >
          <!-- Status Flag Corner -->
          <div class="status-flag" [ngClass]="{
            'flag-ok': service.estado === 'Operando normalmente',
            'flag-impact': service.estado === 'Impactado',
            'flag-degraded': service.estado === 'Degradado',
            'flag-down': service.estado === 'Interrumpido'
          }"></div>
          
          <div class="service-header">
            <div class="service-title">
              <span class="service-name">{{ service.nombre }}</span>

              <span *ngIf="service.maintenanceMode" class="maintenance-badge">En mantenimiento</span>
              <span class="service-status">{{ service.estado }}</span>
              <span *ngIf="getLastHealthStatus(service._id)" class="health-check-badge">Ãšlt. check: {{ getLastHealthStatus(service._id) }}</span>
            </div>
          </div>

          <div class="service-meta">
            <span *ngIf="service.clasificacion?.cadena">ğŸ“¦ {{ service.clasificacion.cadena }}</span>
            <span *ngIf="service.clasificacion?.restaurante">ğŸ· {{ service.clasificacion.restaurante }}</span>
            <span *ngIf="service.importancia" class="importance">âš‘ {{ service.importancia }}</span>
            <span *ngIf="service.manualImportanciaOverride" class="importance-locked" title="Escalamiento automÃ¡tico bloqueado">ğŸ”’ Manual</span>
            <span *ngIf="service.version">ğŸ§¬ v{{ service.version }}</span>
          </div>

          <div *ngIf="service.descripcion">
            <p class="service-description">{{ service.descripcion }}</p>
          </div>
      </div>
    </div>
  </section>

  <!-- CREATE SERVICE MODAL -->
  <section *ngIf="showCreateService" class="create-modal-overlay" (click)="toggleCreateService()">
    <div class="create-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>â• Crear nuevo servicio</h2>
        <button class="modal-close" (click)="toggleCreateService()">âœ•</button>
      </div>
      <div class="modal-content">
        <p class="modal-subtitle">Rellena los datos bÃ¡sicos para crear un nuevo servicio de monitoreo</p>

        <div class="form-grid">
          <div class="form-row">
            <label>Nombre *</label>
            <input [(ngModel)]="newService.nombre" placeholder="Nombre del servicio" required />
          </div>

          <div class="form-row">
            <label>DescripciÃ³n</label>
            <textarea [(ngModel)]="newService.descripcion" placeholder="DescripciÃ³n del servicio..."></textarea>
          </div>

          <div class="form-row">
            <label>Cadena</label>
            <input [(ngModel)]="newService.clasificacion.cadena" placeholder="Ej: GRUPO KFC" />
          </div>

          <div class="form-row">
            <label>Restaurante</label>
            <input [(ngModel)]="newService.clasificacion.restaurante" placeholder="Ej: KFC MALL DEL SOL" />
          </div>

          <div class="form-row">
            <label>URL *</label>
            <input [(ngModel)]="newService.endpoint.url" placeholder="https://example.com/health" required />
          </div>

          <div class="form-row">
            <label>MÃ©todo HTTP</label>
            <select [(ngModel)]="newService.endpoint.metodo">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="PATCH">PATCH</option>
              <option value="DELETE">DELETE</option>
              <option value="HEAD">HEAD</option>
            </select>
          </div>

          <div class="form-row">
            <label>Tipo</label>
            <select [(ngModel)]="newService.tipo">
              <option value="backend">ğŸ”§ Backend</option>
              <option value="frontend">ğŸ¨ Frontend</option>
              <option value="infra">ğŸ“¦ Infraestructura</option>
            </select>
          </div>

          <div class="form-row">
            <label>Ambiente</label>
            <select [(ngModel)]="newService.ambiente">
              <option value="produccion">ğŸš€ ProducciÃ³n</option>
              <option value="staging">ğŸ§ª Staging</option>
              <option value="desarrollo">ğŸ’» Desarrollo</option>
            </select>
          </div>

          <div class="form-row">
            <label>Importancia</label>
            <select [(ngModel)]="newService.importancia">
              <option value="alta">ğŸ”´ Alta</option>
              <option value="media">ğŸŸ¡ Media</option>
              <option value="baja">ğŸŸ¢ Baja</option>
            </select>
          </div>

          <div class="form-row checkbox-row">
            <input type="checkbox" id="serviceActive" [(ngModel)]="newService.activo" />
            <label for="serviceActive">Servicio activo</label>
          </div>
        </div>

        <div class="form-actions">
          <button class="btn-primary" (click)="createService()" [disabled]="creating">
            {{ creating ? 'â³ Creando...' : 'âœ“ Crear servicio' }}
          </button>
          <button class="btn-secondary" (click)="toggleCreateService()" [disabled]="creating">Cancelar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ESPACIADO FINAL -->
  <div class="page-bottom-spacing"></div>

</div>