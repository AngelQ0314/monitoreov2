<div class="maintenance-panel">
  <div class="maintenance-header">
    <h3>Mantenimientos programados</h3>
    <div class="maintenance-header-actions">
      <button class="btn-secondary" (click)="finishAll()" *ngIf="maintenances.length > 0">
        âœ“ Finalizar todos
      </button>
      <button class="btn-danger" (click)="removeAll()" *ngIf="maintenances.length > 0">
        âœ• Eliminar todos
      </button>
    </div>
  </div>

  <!-- Modal de alarma de finalizaciÃ³n -->
  <section *ngIf="showAlarmModal" class="alarm-modal-overlay">
    <div class="alarm-modal">
      <div class="alarm-icon">â°</div>
      <h2>Â¡Mantenimiento Finalizado!</h2>
      <div class="alarm-content">
        <p class="alarm-title">{{ finishedMaintenance?.titulo }}</p>
        <p class="alarm-service">Servicio: <strong>{{ finishedMaintenance?.serviceName }}</strong></p>
        <p class="alarm-message">El tiempo programado para este mantenimiento ha terminado.</p>
        <div class="alarm-time">
          FinalizÃ³: {{ finishedMaintenance?.fechaFin | date:'short' }}
        </div>
      </div>
      <div class="alarm-actions">
        <button class="btn-primary" (click)="finish(finishedMaintenance._id)">âœ“ Marcar como finalizado</button>
        <button class="btn-secondary" (click)="closeAlarm()">âœ• Cerrar alarma</button>
      </div>
    </div>
  </section>

  <div class="maintenance-list">
    <div *ngFor="let m of maintenances" class="maintenance-card" [class.deleting]="deletingMaintenanceIds.has(m._id)">
      <div class="m-row">
        <div>
          <strong>{{ m.titulo }}</strong>
          <div class="m-meta">
            ğŸ“¦ {{ m.serviceName }} Â· 
            <span class="m-estado">{{ m.estado || 'Programado' }}</span>
            <span *ngIf="m.estado !== 'Finalizado'"> Â· <span class="m-impacto">{{ m.modo === 'pause' ? 'â¸ Pausado' : 'ğŸ“‰ Reducido' }}</span></span>
          </div>
        </div>
        <div class="m-actions">
          <button class="btn-secondary" (click)="finish(m._id)" *ngIf="m.estado !== 'Finalizado'" [disabled]="deletingMaintenanceIds.has(m._id)">âœ“ Finalizar</button>
          <button class="btn-secondary danger" (click)="remove(m._id)" [disabled]="deletingMaintenanceIds.has(m._id)">
            {{ deletingMaintenanceIds.has(m._id) ? 'â³ Eliminando...' : 'âœ• Eliminar' }}
          </button>
        </div>
      </div>
      <div class="m-dates">ğŸ• Inicio: {{ m.fechaInicio | date:'short' }} <span *ngIf="m.fechaFin">Â· Fin: {{ m.fechaFin | date:'short' }}</span></div>
      <div class="m-desc" *ngIf="m.descripcion">{{ m.descripcion }}</div>
    </div>
    <div *ngIf="!maintenances.length" class="empty">ğŸ“­ No hay mantenimientos programados</div>
  </div>

  <div class="maintenance-form">
    <h4>â• Crear nuevo mantenimiento</h4>
    <div class="form-row">
      <label>Servicio *</label>
      <select [(ngModel)]="newMaintenance.serviceId" required (change)="cdr.detectChanges()">
        <option value="">-- Seleccionar servicio --</option>
        <option *ngFor="let s of services; trackBy: trackByServiceId" [value]="s._id">{{ s.nombre }} <span *ngIf="s.clasificacion?.cadena">Â· {{ s.clasificacion.cadena }}</span></option>
      </select>
    </div>
    <div class="form-row">
      <label>TÃ­tulo *</label>
      <input [(ngModel)]="newMaintenance.titulo" placeholder="Ej: ActualizaciÃ³n de base de datos" />
    </div>
    <div class="form-row">
      <label>DescripciÃ³n</label>
      <textarea [(ngModel)]="newMaintenance.descripcion" placeholder="Describe el mantenimiento que se realizarÃ¡..."></textarea>
    </div>
    <div class="form-row">
      <label>Inicio *</label>
      <input type="datetime-local" [(ngModel)]="newMaintenance.fechaInicio" required />
    </div>
    <div class="form-row">
      <label>Fin (opcional)</label>
      <input type="datetime-local" [(ngModel)]="newMaintenance.fechaFin" />
    </div>
    <div class="form-row">
      <label>Modo</label>
      <select [(ngModel)]="newMaintenance.modo">
        <option value="pause">â¸ Pausar servicio</option>
        <option value="reduce">ğŸ“‰ Reducir capacidad</option>
      </select>
    </div>
    <div class="form-row">
      <label>Multiplicador (para reducciÃ³n)</label>
      <input type="number" [(ngModel)]="newMaintenance.multiplier" min="0" max="1" step="0.1" placeholder="0.5" />
    </div>
    <div class="form-actions">
      <button class="btn-primary" (click)="create()" [disabled]="creating">{{ creating ? 'Creando...' : 'âœ“ Crear mantenimiento' }}</button>
    </div>
  </div>
</div>
